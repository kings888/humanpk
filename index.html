<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>CSV数据可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .button-container {
            margin: 20px;
        }
        .csv-button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .csv-button:hover {
            background-color: #45a049;
        }
        #tableContainer {
            margin: 20px;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        #chartContainer {
            margin: 20px;
            max-width: 800px;
        }
        .cell-position {
            color: #bbb;
            font-size: 0.7em;
            position: absolute;
            top: 1px;
            right: 2px;
            opacity: 0.6;
            font-weight: 300;
            pointer-events: none;
        }
        td {
            position: relative;
            padding: 16px 8px 8px 8px !important;
        }
        input {
            width: 100% !important;
            box-sizing: border-box;
            padding: 2px 4px;
        }
        .row-header {
            color: #bbb;
            font-size: 0.7em;
            text-align: center;
            font-weight: 300;
        }
    </style>
</head>
<body>
    <div class="button-container">
        <button class="csv-button" onclick="loadCSV('Allometry-CL.csv')">Allometry-CL</button>
        <button class="csv-button" onclick="loadCSV('CL and Vss in preclinical.csv')">CL and Vss in preclinical</button>
        <button class="csv-button" onclick="loadCSV('FCIM.csv')">FCIM</button>
        <button class="csv-button" onclick="loadCSV('IVIVE for CL.csv')">IVIVE for CL</button>
        <button class="csv-button" onclick="loadCSV('Wajim-CL.csv')">Wajim-CL</button>
    </div>
    <div id="tableContainer"></div>
    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let currentChart = null;
        let currentFCIMData = null;
        let currentCLVssData = null;

        function loadCSV(filename) {
            const serverUrl = 'http://localhost:8000/';
            const config = {
                download: true,
                dynamicTyping: true,
                skipEmptyLines: false,  // 默认配置
                error: function(error) {
                    console.error('加载错误:', error);
                    alert('无法加载CSV文件，请确保本地服务器正在运行');
                }
            };

            // 根据不同的文件使用不同的配置
            switch(filename) {
                case 'Allometry-CL.csv':
                    config.header = false;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Raw data:', results.data);

                        // 定义常数值
                        const constants = {
                            'Mouse': { 'Body Weight (kg)': 0.025, 'Brain Weight (kg)': 0.0004 },
                            'Rat': { 'Body Weight (kg)': 0.3, 'Brain Weight (kg)': 0.0018 },
                            'Dog': { 'Body Weight (kg)': 10, 'Brain Weight (kg)': 0.08 },
                            'Monkey': { 'Body Weight (kg)': 5, 'Brain Weight (kg)': 0.09 },
                            'Human': { 'Body Weight (kg)': 60, 'Brain Weight (kg)': 1.4 }
                        };

                        // 处理第一个表的数据
                        const mainData = [];
                        const animals = ['Mouse', 'Rat', 'Dog', 'Monkey', 'Human'];

                        animals.forEach(animal => {
                            const obj = {
                                'Animal': animal,
                                'Body Weight (kg)': constants[animal]['Body Weight (kg)'],
                                'Brain Weight (kg)': constants[animal]['Brain Weight (kg)'],
                                'MLP (years)': 1,  // 默认值
                                'Fu': 1,  // 默认值
                                'Cl(L/h)': null,
                                'Vdss（L）': null,
                                'CL*MLP': null,
                                'CL*BrW': null,
                                'CL/Fu': null,
                                'CL/Fu*MLP': null,
                                'CL/Fu*BrW': null
                            };
                            mainData.push(obj);
                        });

                        // 处理第二个表的数据（对数值表）
                        const logData = [
                            {
                                'Item': 'Mean',
                                'Log BW': null,
                                'if 0.55＜b ≤0.71': null,
                                'if 0.71＜b ≤1': null,
                                'if 1＜b ≤1.3': null,
                                'log CL*BrW': null,
                                'log CL/Fu': null,
                                'log CL/Fu*MLP': null,
                                'log CL/Fu*BrW': null
                            },
                            {
                                'Item': 'SD',
                                'Log BW': null,
                                'if 0.55＜b ≤0.71': null,
                                'if 0.71＜b ≤1': null,
                                'if 1＜b ≤1.3': null,
                                'log CL*BrW': null,
                                'log CL/Fu': null,
                                'log CL/Fu*MLP': null,
                                'log CL/Fu*BrW': null
                            }
                        ];

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                        tablesHtml += '<h3>Basic Parameters</h3>';
                        tablesHtml += createAllometryTableHtml(mainData);
                        
                        // 第二个表格
                        tablesHtml += '<h3 style="margin-top: 20px;">Logarithmic Values</h3>';
                        tablesHtml += createTableHtml(logData);
                        
                        tablesHtml += '</div>';
                        
                        document.getElementById('tableContainer').innerHTML = tablesHtml;

                        // 更新图表（使用第一个表的数据）
                        updateChart(mainData, filename);
                    };
                    break;

                case 'CL and Vss in preclinical.csv':
                    config.header = true;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Raw data:', results.data);

                        // 创建两个独立的表格数据
                        const table1 = [
                            // 第一个表的标题行
                            {
                                'Compound': 'Compound',
                                'BW(kg)': 'BW(kg)',
                                'fu': 'fu'
                            }
                        ];

                        const table2 = [
                            // 第二个表的标题行
                            {
                                'Compound': 'Compound',
                                'CL(L/h)': 'CL(L/h)',
                                'CL/fu': 'CL/fu',
                                'Vss (L)': 'Vss (L)',
                                'Vss/fu': 'Vss/fu'
                            }
                        ];

                        // 处理数据行
                        results.data.forEach(row => {
                            if (row['Compound']) {
                                // 添加到第一个表
                                table1.push({
                                    'Compound': row['Compound'],
                                    'BW(kg)': row['BW(kg)'],
                                    'fu': row['fu']
                                });

                                // 添加到第二个表
                                table2.push({
                                    'Compound': row['Compound'],
                                    'CL(L/h)': row['CL(L/h)'],
                                    'CL/fu': row['CL/fu'],
                                    'Vss (L)': row['Vss (L)'],
                                    'Vss/fu': row['Vss/fu']
                                });
                            }
                        });

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                        tablesHtml += '<h3>Basic Parameters</h3>';
                        tablesHtml += createTableHtml(table1);
                        
                        // 第二个表格
                        tablesHtml += '<h3 style="margin-top: 20px;">CL and Vss Values</h3>';
                        tablesHtml += createTableHtml(table2);
                        
                        tablesHtml += '</div>';
                        
                        document.getElementById('tableContainer').innerHTML = tablesHtml;

                        // 存储数据到全局变量（用于编辑功能）
                        currentCLVssData = {
                            table1: table1,
                            table2: table2
                        };

                        // 更新图表（使用第二个表的数据）
                        updateChart(table2, filename);
                    };
                    break;

                case 'FCIM.csv':
                    config.header = false;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        const startRow = 9;  // 0-based index
                        const headers = ['Animal', 'Body Weight (kg)', 'CL (mL/min)', 'Log BW', 'Log CL'];
                        
                        const cleanData = results.data
                            .slice(startRow)
                            .filter(row => row && row.length >= headers.length)
                            .map(row => {
                                const obj = {};
                                headers.forEach((header, i) => {
                                    let value = row[i];
                                    if (value === '#REF!' || value === '#DIV/0!' || value === '#VALUE!' || value === '') {
                                        value = null;
                                    }
                                    obj[header] = value;
                                });
                                return obj;
                            })
                            .filter(row => Object.values(row).some(v => v !== null));
                        
                        // 存储FCIM数据到全局变量
                        currentFCIMData = cleanData;
                        
                        displayData(cleanData, filename);
                    };
                    break;

                case 'IVIVE for CL.csv':
                    config.header = true;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('IVIVE raw data:', results.data); // 调试用

                        // 只保留有效的数据行
                        const cleanData = results.data
                            .filter(row => {
                                // 检查是否为有效行
                                return row && 
                                       typeof row === 'object' && 
                                       Object.keys(row).length > 0 &&
                                       !Object.keys(row).every(key => !row[key]);
                            })
                            .map(row => {
                                const cleanRow = {};
                                Object.entries(row).forEach(([key, value]) => {
                                    // 处理特殊值
                                    if (value === '#REF!' || value === '#DIV/0!' || value === '#VALUE!' || value === '') {
                                        cleanRow[key] = null;
                                    } else {
                                        cleanRow[key] = value;
                                    }
                                });
                                return cleanRow;
                            });

                        console.log('IVIVE clean data:', cleanData); // 调试用
                        displayData(cleanData, filename);
                    };
                    break;

                case 'Wajim-CL.csv':
                    config.header = false;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Wajim raw data:', results.data);

                        // 创建两个独立的数据集
                        const mainData = [
                            // 设置固定值
                            { Parameter: 'CLrat', Value: 6.20 },
                            { Parameter: 'CLdog', Value: 2.15 },
                            { Parameter: 'MW', Value: 614 },
                            { Parameter: 'Ha', Value: 12 }
                        ];
                        
                        // 创建 CL human 数据表
                        const clHumanData = [
                            // 第一行：标题行
                            {
                                Col1: 'logCLhuman',
                                Col2: 'mL/min/kg',
                                Col3: 'mL/min',
                                Col4: 'L/hr'
                            },
                            // 第二行：可输入的值
                            {
                                Col1: null,
                                Col2: null,
                                Col3: null,
                                Col4: null
                            }
                        ];

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                        tablesHtml += '<h3>Main Parameters</h3>';
                        tablesHtml += createTableHtml(mainData);
                        
                        // 第二个表格
                        tablesHtml += '<h3 style="margin-top: 20px;">CL Human Values</h3>';
                        tablesHtml += createEditableTableHtml(clHumanData);
                        
                        tablesHtml += '</div>';
                        
                        document.getElementById('tableContainer').innerHTML = tablesHtml;

                        // 更新图表（使用主数据）
                        updateChart(mainData, filename);
                    };
                    break;

                default:
                    config.header = true;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Raw data:', results.data);

                        // 清理数据并只保留有数据的列
                        const cleanData = results.data
                            .filter(row => Object.values(row).some(v => v !== null && v !== ''))
                            .map(row => {
                                // 只保留有数据的列
                                const cleanRow = {};
                                if (row['Compound']) cleanRow['Compound'] = row['Compound'];
                                if (row['BW(kg)']) cleanRow['BW(kg)'] = row['BW(kg)'];
                                if (row['fu']) cleanRow['fu'] = row['fu'];
                                if (row['CL(L/h)']) cleanRow['CL(L/h)'] = row['CL(L/h)'];
                                if (row['CL/fu']) cleanRow['CL/fu'] = row['CL/fu'];
                                if (row['Vss (L)']) cleanRow['Vss (L)'] = row['Vss (L)'];
                                if (row['Vss/fu']) cleanRow['Vss/fu'] = row['Vss/fu'];
                                return cleanRow;
                            })
                            .filter(row => Object.keys(row).length > 0); // 确保行中有数据

                        // 存储数据到全局变量
                        if (filename === 'CL and Vss in preclinical.csv') {
                            currentCLVssData = cleanData;
                        }
                        
                        displayData(cleanData, filename);
                    };
                    break;
            }

            // 添加调试信息
            console.log('正在加载文件:', filename);
            console.log('使用的配置:', config);

            Papa.parse(serverUrl + filename, config);
        }

        function getColumnLabel(index) {
            let label = '';
            while (index >= 0) {
                label = String.fromCharCode(65 + (index % 26)) + label;
                index = Math.floor(index / 26) - 1;
            }
            return label;
        }

        function displayData(data, filename) {
            if (!data || data.length === 0) {
                console.error('没有数据可显示');
                return;
            }
            
            // 创建表格
            let table = '<table><thead><tr><th></th>';  // 添加一个空的角落单元格
            const headers = Object.keys(data[0]);
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            // 根据文件类型使用不同的表格单元格渲染方式
            if (filename === 'FCIM.csv' || filename === 'CL and Vss in preclinical.csv') {
                data.forEach((row, rowIndex) => {
                    table += `<tr><td class="row-header">${rowIndex + 1}</td>`;  // 添加行号
                    headers.forEach((header, colIndex) => {
                        const value = row[header];
                        const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                        
                        if ((filename === 'FCIM.csv' && header === 'CL (mL/min)') ||
                            (filename === 'CL and Vss in preclinical.csv' && 
                             (header === 'CL/F(mL/min/kg)' || header === 'Vd/F (L/kg)' || 
                              header === 'CL(mL/min)' || header === 'CL(L/h)' || 
                              header === 'Vss (L)' || header === 'fu' || 
                              header === 'CL/fu' || header === 'Vss/fu'))) {
                            
                            table += `<td>
                                <div class="cell-position">${cellPosition}</div>
                                <input type="number" 
                                    value="${value || ''}" 
                                    step="0.0001"
                                    data-position="${cellPosition}"
                                    onchange="${filename === 'FCIM.csv' ? 
                                        `updateCLValue(${rowIndex}, this.value)` : 
                                        `updateCLVssValue(${rowIndex}, '${header}', this.value)`}"
                                />
                            </td>`;
                        } else {
                            let formattedValue = '';
                            if (typeof value === 'number' && !isNaN(value)) {
                                formattedValue = value.toFixed(4);
                            } else if (value === '#REF!' || value === '#DIV/0!' || value === '#VALUE!') {
                                formattedValue = 'N/A';
                            } else {
                                formattedValue = value || '';
                            }
                            table += `<td>
                                <div class="cell-position">${cellPosition}</div>
                                ${formattedValue}
                            </td>`;
                        }
                    });
                    table += '</tr>';
                });
            } else {
                // 其他文件的显示逻辑
                data.forEach((row, rowIndex) => {
                    table += `<tr><td class="row-header">${rowIndex + 1}</td>`;
                    headers.forEach((header, colIndex) => {
                        const value = row[header];
                        const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                        let formattedValue = '';
                        if (typeof value === 'number' && !isNaN(value)) {
                            formattedValue = value.toFixed(4);
                        } else if (value === '#REF!' || value === '#DIV/0!' || value === '#VALUE!') {
                            formattedValue = 'N/A';
                        } else {
                            formattedValue = value || '';
                        }
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${formattedValue}
                        </td>`;
                    });
                    table += '</tr>';
                });
            }

            table += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = table;

            // 更新图表
            updateChart(data, filename);
        }

        function updateChart(data, filename) {
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            const headers = Object.keys(data[0]);
            
            // 根据文件名选择合适的图表配置
            const chartConfig = getChartConfig(filename, data, headers);
            currentChart = new Chart(ctx, chartConfig);
        }

        function getChartConfig(filename, data, headers) {
            if (filename === 'Allometry-CL.csv') {
                // 找到包含有效数据的列
                const validHeaders = headers.filter(header => 
                    data.some(row => row[header] !== null && !isNaN(row[header]))
                );

                // 找到可能的x轴数据（通常是体重或其他度量）
                const xHeader = validHeaders.find(h => 
                    h.toLowerCase().includes('weight') || 
                    h.toLowerCase().includes('bw') ||
                    h.toLowerCase().includes('brain')
                ) || validHeaders[0];

                // 创建数据集
                const datasets = validHeaders
                    .filter(header => header !== xHeader)
                    .map(header => ({
                        label: header,
                        data: data
                            .filter(row => 
                                row[xHeader] !== null && 
                                row[header] !== null && 
                                !isNaN(row[xHeader]) && 
                                !isNaN(row[header])
                            )
                            .map(row => ({
                                x: row[xHeader],
                                y: row[header]
                            })),
                        backgroundColor: getRandomColor()
                    }))
                    .filter(dataset => dataset.data.length > 0);

                return {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Allometry Analysis',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: (${context.parsed.x}, ${context.parsed.y})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: xHeader
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Values'
                                }
                            }
                        }
                    }
                };
            }
            
            // 根据不同的文件选择不同的图表配置
            if (filename === 'CL and Vss in preclinical.csv') {
                return {
                    type: 'bar',
                    data: {
                        labels: data.map(row => row['Compound']),  // 使用 Compound 作为标签
                        datasets: [
                            {
                                label: 'CL(L/h)',
                                data: data.map(row => row['CL(L/h)']),
                                backgroundColor: 'rgba(75, 192, 192, 0.5)'
                            },
                            {
                                label: 'Vss (L)',
                                data: data.map(row => row['Vss (L)']),
                                backgroundColor: 'rgba(255, 99, 132, 0.5)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'CL and Vss in Preclinical',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true,
                                    text: 'Value'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                };
            }
            
            // 修改FCIM的图表配置
            if (filename === 'FCIM.csv') {
                return {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Log CL vs Log BW',
                            data: data
                                .filter(row => 
                                    row['Log BW'] !== null && 
                                    row['Log CL'] !== null && 
                                    !isNaN(row['Log BW']) && 
                                    !isNaN(row['Log CL'])
                                )
                                .map(row => ({
                                    x: row['Log BW'],
                                    y: row['Log CL']
                                })),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'FCIM Analysis - Log CL vs Log BW',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `(${context.parsed.x.toFixed(4)}, ${context.parsed.y.toFixed(4)})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Log BW'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Log CL'
                                }
                            }
                        }
                    }
                };
            }
            
            if (filename === 'IVIVE for CL.csv') {
                return {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'CLint vs fu',
                            data: data
                                .filter(row => 
                                    row['CLint'] !== null && 
                                    row['fu, inc'] !== null &&
                                    !isNaN(row['CLint']) && 
                                    !isNaN(row['fu, inc'])
                                )
                                .map(row => ({
                                    x: row['fu, inc'],
                                    y: row['CLint']
                                })),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'IVIVE Analysis',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'fu, inc'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'CLint'
                                }
                            }
                        }
                    }
                };
            }
            
            if (filename === 'Wajim-CL.csv') {
                // 只使用数值类型的数据进行图表显示
                const numericData = data.filter(row => 
                    row.Value !== null && 
                    typeof row.Value === 'number' && 
                    !isNaN(row.Value)
                );
                
                return {
                    type: 'bar',
                    data: {
                        labels: numericData.map(row => row.Parameter),
                        datasets: [{
                            label: 'Values',
                            data: numericData.map(row => row.Value),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: numericData.length === 0 ? 'No numeric data available' : 'Wajim-CL Analysis',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const row = numericData[context.dataIndex];
                                        return row ? `${row.Value.toFixed(4)}${row.Unit ? ' ' + row.Unit : ''}` : '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                };
            }
            
            // 默认配置（用于其他文件）
            return {
                type: 'scatter',
                data: {
                    datasets: headers.slice(1).map(header => ({
                        label: header,
                        data: data.map(row => ({
                            x: row[headers[0]],
                            y: row[header]
                        })).filter(point => 
                            point.x !== null && 
                            point.y !== null && 
                            !isNaN(point.x) && 
                            !isNaN(point.y)
                        ),
                        backgroundColor: getRandomColor()
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: filename,
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: ${value.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: headers[0]
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '值'
                            }
                        }
                    }
                }
            };
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 添加更新CL值的函数
        function updateCLValue(rowIndex, newValue) {
            if (!currentFCIMData) return;

            // 更新数据
            currentFCIMData[rowIndex]['CL (mL/min)'] = parseFloat(newValue);
            
            // 计算新的Log CL值
            if (!isNaN(newValue) && newValue > 0) {
                currentFCIMData[rowIndex]['Log CL'] = Math.log10(parseFloat(newValue));
            } else {
                currentFCIMData[rowIndex]['Log CL'] = null;
            }

            // 更新图表
            updateChart(currentFCIMData, 'FCIM.csv');
        }

        // 添加更新 CL and Vss 值的函数
        function updateCLVssValue(rowIndex, header, newValue) {
            if (!currentCLVssData) return;

            // 更新数据
            const value = parseFloat(newValue);
            if (!isNaN(value)) {
                currentCLVssData[rowIndex][header] = value;

                // 根据不同的字段更新相关的计算值
                const row = currentCLVssData[rowIndex];
                const BW = row['BW(kg)'];

                switch(header) {
                    case 'CL(L/h)':
                        if (row['fu']) {
                            row['CL/fu'] = value / row['fu'];
                        }
                        break;
                    case 'Vss (L)':
                        if (row['fu']) {
                            row['Vss/fu'] = value / row['fu'];
                        }
                        break;
                    case 'fu':
                        if (row['CL(L/h)']) {
                            row['CL/fu'] = row['CL(L/h)'] / value;
                        }
                        if (row['Vss (L)']) {
                            row['Vss/fu'] = row['Vss (L)'] / value;
                        }
                        break;
                }

                // 更新显示
                displayData(currentCLVssData, 'CL and Vss in preclinical.csv');
            }
        }

        // 添加创建表格的辅助函数
        function createTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            data.forEach((row, rowIndex) => {
                table += `<tr><td class="row-header">${rowIndex + 1}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                    let formattedValue = '';
                    if (typeof value === 'number' && !isNaN(value)) {
                        formattedValue = value.toFixed(4);
                    } else if (value === '#REF!' || value === '#DIV/0!' || value === '#VALUE!') {
                        formattedValue = 'N/A';
                    } else {
                        formattedValue = value || '';
                    }
                    table += `<td>
                        <div class="cell-position">${cellPosition}</div>
                        ${formattedValue}
                    </td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 修改创建可编辑表格的函数
        function createEditableTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th><div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            data.forEach((row, rowIndex) => {
                table += `<tr><td class="row-header">${rowIndex + 1}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                    
                    if (rowIndex === 1) {  // 第二行是可编辑的
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            <input type="number" 
                                value="${value || ''}" 
                                step="0.0001"
                                style="width: 100px;"
                                onchange="updateCLHumanValue(${colIndex}, this.value)"
                            />
                        </td>`;
                    } else {  // 第一行是标题
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${value || ''}
                        </td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 修改更新 CL human 值的函数
        function updateCLHumanValue(colIndex, newValue) {
            console.log(`Updated column ${colIndex} with value ${newValue}`);
            // 这里可以添加值更新后的处理逻辑，比如计算其他列的值
            // 例如，如果输入了 mL/min/kg，可以自动计算 mL/min 和 L/hr
        }

        // 添加新的函数来创建特殊的Allometry表格
        function createAllometryTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            
            // 创建表头
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            // 创建数据行
            data.forEach((row, rowIndex) => {
                table += `<tr><td class="row-header">${rowIndex + 1}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                    
                    // 根据不同列类型创建不同的单元格
                    if (header === 'Body Weight (kg)' || header === 'Brain Weight (kg)') {
                        // 常数列 - 只显示值
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${value?.toFixed(4) || ''}
                        </td>`;
                    } else if (header === 'MLP (years)' || header === 'Fu') {
                        // 可编辑列 - 默认值为1
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            <input type="number" 
                                value="${value || 1}" 
                                step="0.0001"
                                style="width: 100px;"
                                onchange="updateAllometryValue('${header}', ${rowIndex}, this.value)"
                            />
                        </td>`;
                    } else {
                        // 其他列 - 普通显示
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${typeof value === 'number' ? value.toFixed(4) : (value || '')}
                        </td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }
    </script>
</body>
</html> 