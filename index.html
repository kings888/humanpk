<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>CSV数据可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .button-container {
            margin: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .csv-button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .csv-button:hover {
            background-color: #45a049;
        }
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 20px;
        }
        .buttons-and-title {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .title-section {
            text-align: center;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .title-text {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo {
            height: 40px;
            margin: 0;
            background-color: white;
            padding: 2px;
            border-radius: 4px;
        }
        .main-title {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .sub-title {
            margin: 5px 0 0 0;
            font-size: 16px;
            color: #666;
        }
        #tableContainer {
            margin: 20px;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        #chartContainer {
            margin: 20px;
            max-width: 800px;
        }
        .cell-position {
            color: #bbb;
            font-size: 0.7em;
            position: absolute;
            top: 1px;
            right: 2px;
            opacity: 0.6;
            font-weight: 300;
            pointer-events: none;
        }
        td {
            position: relative;
            padding: 16px 8px 8px 8px !important;
        }
        input {
            width: 100% !important;
            box-sizing: border-box;
            padding: 2px 4px;
        }
        .row-header {
            color: #bbb;
            font-size: 0.7em;
            text-align: center;
            font-weight: 300;
        }
        .constant-cell {
            background-color: #f0f0f0;
        }
        .input-cell {
            background-color: #fff;
        }
        .output-cell {
            background-color: #fff;
        }
        .cell-container {
            position: relative;
        }
        .cell-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            padding: 2px 4px;
        }
        .cell-content {
            position: relative;
        }
        .error-value {
            color: red;
        }
        .readonly {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
        .editable {
            background-color: white;
            cursor: text;
        }
        .data-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            min-width: 100px;  /* 设置最小列宽 */
            position: relative;
        }
        .data-table .header-row td {
            background-color: #4CAF50;  /* 绿色背景 */
            color: white;  /* 白色字体 */
            font-weight: bold;
        }
        .data-table .cell-input {
            width: 90%;  /* 输入框宽度 */
            padding: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="button-container">
        <div class="header-container">
            <div class="buttons-and-title">
                <div class="buttons-row">
                    <button class="csv-button" onclick="loadCSV('Allometry-CL.csv')">Allometry-CL</button>
                    <button class="csv-button" onclick="loadCSV('CL and Vss in preclinical.csv')">CL and Vss in preclinical</button>
                    <button class="csv-button" onclick="loadCSV('FCIM.csv')">FCIM</button>
                    <button class="csv-button" onclick="loadCSV('IVIVE for CL.csv')">IVIVE for CL</button>
                    <button class="csv-button" onclick="loadCSV('Wajim-CL.csv')">Wajim-CL</button>
                </div>
                <div class="title-section">
                    <div class="title-text">
                        <img src="logo.png" alt="Company Logo" class="logo">
                        <div>
                            <h1 class="main-title">Human PK Analysis</h1>
                            <p class="sub-title">Pharmacokinetic Data Analysis Tool</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="tableContainer"></div>
    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let currentChart = null;
        let currentFCIMData = null;
        let currentCLVssData = null;
        let currentAllometryData = null;
        let currentWajimData = null;
        let currentIVIVEData = null; // 添加IVIVE数据的存储变量

        // 添加IVIVE表格的列标题定义
        const iviveHeaders = [
            'Compound ID', 'clogP', 'Species', 'T1/2 (min)', 'CLint', 'fu, inc', 'CLint,u', 'T1/2 (min)', 
            'CLint', 'fu, inc', 'CLint,u', 'fu, p', 'MPPGL (mg/g)', 'HPGL (million/g)', 'Qh (mL/min/kg)', 
            'Liver (g/kg)', 'CLh pred. Clint', 'CLh pred. Clint, u', 'CLh pred. Clint', 'CLh pred. Clint, u', 
            'CL,obs (mL/min/kg)', 'CL,obs (mL/min/kg)'
        ];

        function loadCSV(filename) {
            console.log('尝试加载文件:', filename);
            
            fetch(filename)
                .then(response => response.text())
                .then(csvData => {
            const config = {
                        download: false,
                dynamicTyping: true,
                skipEmptyLines: false,
                error: function(error) {
                    console.error('加载错误:', error);
                            alert('无法加载CSV文件，请确保文件存在');
                }
            };

            // 根据不同的文件使用不同的配置
            switch(filename) {
                case 'Allometry-CL.csv':
                    config.header = false;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        // 设置所有12列
                        const mainTableColumns = [
                            'Animal',
                            'Body Weight (kg)',
                            'Brain Weight (kg)',
                            'MLP (years)',
                            'Cl(L/h)',
                            'Vdss（L）',
                            'Fu',
                            'CL*MLP',
                            'CL*BrW',
                            'CL/Fu',
                            'CL/Fu*MLP',
                            'CL/Fu*BrW'
                        ];

                        // 处理第一个表的数据
                        const mainData = [];
                        const animals = ['Mouse', 'Rat', 'Dog', 'Monkey', 'Human'];

                        // 添加原有的5行数据
                        animals.forEach((animal, index) => {
                            const rowData = {};
                            mainTableColumns.forEach(column => {
                                if (column === 'Animal') {
                                    rowData[column] = animal;
                                } else if (column === 'Body Weight (kg)') {
                                    // 设置固定的 Body Weight 值
                                    switch(animal) {
                                        case 'Mouse': rowData[column] = 0.025; break;
                                        case 'Rat': rowData[column] = 0.3; break;
                                        case 'Dog': rowData[column] = 10; break;
                                        case 'Monkey': rowData[column] = 5; break;
                                        default: rowData[column] = 60; break;
                                    }
                                } else if (column === 'Brain Weight (kg)') {
                                    // 计算 Brain Weight
                                    const bodyWeight = rowData['Body Weight (kg)'];
                                    switch(animal) {
                                        case 'Mouse': rowData[column] = bodyWeight * 1.65/100; break;
                                        case 'Rat': rowData[column] = bodyWeight * 0.57/100; break;
                                        case 'Dog': rowData[column] = bodyWeight * 0.78/100; break;
                                        case 'Monkey': rowData[column] = bodyWeight * 1.56/100; break;
                                        default: rowData[column] = bodyWeight * 2/100; break;
                                    }
                                } else if (column === 'MLP (years)') {
                                    // 计算 MLP
                                    const bodyWeight = rowData['Body Weight (kg)'];
                                    const brainWeight = rowData['Brain Weight (kg)'];
                                    if (bodyWeight && brainWeight) {
                                        rowData[column] = 185.4 * Math.pow(brainWeight, 0.636) * Math.pow(bodyWeight, -0.225);
                                    }
                                } else if (column === 'Fu') {
                                    // 设置Fu的值
                                    switch(animal) {
                                        case 'Mouse': rowData[column] = 0.05; break;
                                        case 'Rat': rowData[column] = 0.02; break;
                                        case 'Dog': rowData[column] = 0.03; break;
                                        case 'Monkey': rowData[column] = 0.05; break;
                                        case 'Human': rowData[column] = 0.01; break;
                                    }
                                } else if (column === 'Cl(L/h)') {
                                    // 设置Cl(L/h)的值
                                    switch(animal) {
                                        case 'Mouse': rowData[column] = 0.003288; break;
                                        case 'Rat': rowData[column] = 0.07; break;
                                        case 'Dog': rowData[column] = 0.62; break;
                                        case 'Monkey': rowData[column] = 1.166; break;
                                        default: rowData[column] = null; break;
                                    }
                                } else {
                                    rowData[column] = null;
                                }
                            });

                            // 计算其他列的值
                            if (rowData['Cl(L/h)'] && rowData['MLP (years)']) {
                                rowData['CL*MLP'] = rowData['Cl(L/h)'] * rowData['MLP (years)'];
                            }
                            if (rowData['Cl(L/h)'] && rowData['Brain Weight (kg)']) {
                                rowData['CL*BrW'] = rowData['Cl(L/h)'] * rowData['Brain Weight (kg)'];
                            }
                            if (rowData['Cl(L/h)'] && rowData['Fu']) {
                                rowData['CL/Fu'] = rowData['Cl(L/h)'] / rowData['Fu'];
                            }
                            if (rowData['CL/Fu'] && rowData['MLP (years)']) {
                                rowData['CL/Fu*MLP'] = rowData['CL/Fu'] * rowData['MLP (years)'];
                            }
                            if (rowData['CL/Fu'] && rowData['Brain Weight (kg)']) {
                                rowData['CL/Fu*BrW'] = rowData['CL/Fu'] * rowData['Brain Weight (kg)'];
                            }

                            mainData.push(rowData);
                        });

                        // 添加新的5行Human数据
                        for (let i = 0; i < 5; i++) {
                            const rowData = {};
                            mainTableColumns.forEach(column => {
                                if (column === 'Animal') {
                                            // 第一行（27行）清空Animal值，其他行保持Human
                                            rowData[column] = i === 0 ? '' : 'Human';
                                } else if (column === 'Body Weight (kg)') {
                                    rowData[column] = 60;
                                } else if (column === 'Brain Weight (kg)') {
                                    rowData[column] = 60 * 2/100;
                                } else if (column === 'MLP (years)') {
                                    const bodyWeight = 60;
                                    const brainWeight = 60 * 2/100;
                                    rowData[column] = 185.4 * Math.pow(brainWeight, 0.636) * Math.pow(bodyWeight, -0.225);
                                } else if (column === 'Fu') {
                                    rowData[column] = 0.01;
                                } else {
                                    rowData[column] = null;
                                }
                            });
                            mainData.push(rowData);
                        }

                        // 处理第二个表的数据（对数值表）
                        const logData = animals.map(animal => ({
                            'Item': animal,
                            'Log BW': null,
                            'if 0.55＜b ≤0.71': null,
                            'if 0.71＜b ≤1': null,
                            'if 1＜b ≤1.3': null,
                            'log CL*BrW': null,
                            'log CL/Fu': null,
                            'log CL/Fu*MLP': null,
                            'log CL/Fu*BrW': null
                        }));

                        // 初始化对数表的值
                        mainData.forEach((mainRow, index) => {
                            if (index < logData.length) {
                                const logRow = logData[index];
                                
                                if (mainRow['Body Weight (kg)'] > 0) {
                                    logRow['Log BW'] = Math.log10(mainRow['Body Weight (kg)']);
                                }
                                if (mainRow['Cl(L/h)'] > 0) {
                                    logRow['if 0.55＜b ≤0.71'] = Math.log10(mainRow['Cl(L/h)']);
                                }
                                if (mainRow['CL*MLP'] > 0) {
                                    logRow['if 0.71＜b ≤1'] = Math.log10(mainRow['CL*MLP']);
                                }
                                if (mainRow['CL*BrW'] > 0) {
                                    logRow['if 1＜b ≤1.3'] = Math.log10(mainRow['CL*BrW']);
                                    logRow['log CL*BrW'] = Math.log10(mainRow['CL*BrW']);
                                }
                                if (mainRow['CL/Fu'] > 0) {
                                    logRow['log CL/Fu'] = Math.log10(mainRow['CL/Fu']);
                                }
                                if (mainRow['CL/Fu*MLP'] > 0) {
                                    logRow['log CL/Fu*MLP'] = Math.log10(mainRow['CL/Fu*MLP']);
                                }
                                if (mainRow['CL/Fu*BrW'] > 0) {
                                    logRow['log CL/Fu*BrW'] = Math.log10(mainRow['CL/Fu*BrW']);
                                }
                            }
                        });

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                        tablesHtml += '<h3>Basic Parameters</h3>';
                        tablesHtml += createAllometryTableHtml(mainData);
                        
                        // 第二个表格
                        tablesHtml += '<h3 style="margin-top: 20px;">Logarithmic Values</h3>';
                        tablesHtml += createTableHtml(logData);
                        
                        // 添加拟合图按钮
                        tablesHtml += '<div style="margin-top: 20px; text-align: center;">';
                        tablesHtml += '<button class="csv-button" onclick="plotFitting1()">拟合图1</button>';
                        tablesHtml += '<button class="csv-button" onclick="plotFitting2()">拟合图2</button>';
                        tablesHtml += '<button class="csv-button" onclick="plotFitting3()">拟合图3</button>';
                        tablesHtml += '<button class="csv-button" onclick="plotFitting4()">拟合图4</button>';
                        tablesHtml += '</div>';
                        
                        tablesHtml += '</div>';
                        
                        document.getElementById('tableContainer').innerHTML = tablesHtml;

                        // 存储数据到全局变量
                        currentAllometryData = {
                            mainData: mainData,
                            logData: logData
                        };

                        // 更新图表
                        updateChart(mainData, filename);
                    };
                    break;

                case 'CL and Vss in preclinical.csv':
                    config.header = false;
                    config.skipEmptyLines = false;
                    config.complete = function(results) {
                        console.log('CL and Vss raw data:', results.data);
                        
                        // 创建表格HTML
                        let table = '<div style="margin-bottom: 20px;">';
                        table += '<table class="data-table">';
                        
                        // 添加标题行
                        table += '<thead><tr style="background-color: #4CAF50; color: white;">';
                        const headers = ['Animal', 'Dose (mg/kg)', 'BW(kg)', 'CL/F(mL/min/kg)', 'CL(mL/min)', 
                                        'CL(L/h)', 'Vd/F (L/kg)', 'Vss (L)', 'fu', 'CL/fu', 'Vss/fu'];
                        headers.forEach((header, j) => {
                            const cellPosition = `${getColumnLabel(j)}1`;
                            table += `<td class="cell-container">
                                <div class="cell-position" style="color: rgba(255,255,255,0.7);">${cellPosition}</div>
                                <div class="cell-content">${header}</div>
                            </td>`;
                        });
                        table += '</tr></thead><tbody>';
                        
                        // 处理数据行，跳过第二行（索引为1的行）
                        for (let i = 0; i < results.data.length; i++) {
                            if (i === 1) continue; // 跳过第二行
                            
                            const row = results.data[i];
                            if (row.every(cell => !cell)) continue; // 跳过其他空行
                            
                            table += '<tr>';
                            for (let j = 0; j < row.length; j++) {
                                let cellContent = row[j] || '';
                                const cellPosition = `${getColumnLabel(j)}${i+1}`;
                                
                                // 检查是否是可编辑列
                                // BW(kg), CL/F, CL(mL/min), CL(L/h), Vd/F, Vss, fu 是可编辑的
                                const editableColumns = [2, 3, 4, 5, 6, 7, 8];
                                
                                if (editableColumns.includes(j) && i > 0) {
                                    table += `<td class="cell-container">
                                        <div class="cell-position">${cellPosition}</div>
                                        <input type="number" 
                                            class="cell-input"
                                            value="${cellContent}" 
                                            step="0.000001"
                                            data-row="${i}"
                                            data-col="${j}"
                                            onchange="updateCLVssValue(this.value, this.dataset.row, this.dataset.col)"
                                        />
                                    </td>`;
                                } else {
                                    // 格式化数字
                                    if (!isNaN(parseFloat(cellContent)) && isFinite(cellContent)) {
                                        const num = parseFloat(cellContent);
                                        if (num % 1 !== 0) {
                                            cellContent = num.toFixed(6);
                                        }
                                    }
                                    
                                    table += `<td class="cell-container">
                                        <div class="cell-position">${cellPosition}</div>
                                        <div class="cell-content">${cellContent}</div>
                                    </td>`;
                                }
                            }
                            table += '</tr>';
                        }
                        
                        table += '</tbody></table></div>';
                        
                        // 显示表格
                        document.getElementById('tableContainer').innerHTML = table;
                        
                        // 存储数据到全局变量
                        currentCLVssData = results.data;
                    };
                    break;

                case 'FCIM.csv':
                    config.header = false;
                            config.skipEmptyLines = false;
                    config.complete = function(results) {
                                console.log('FCIM raw data:', results.data);  // 添加调试日志
                                
                                // 第一个表的数据处理
                                const headers = ['Item', 'Animal', 'Body Weight (kg)', 'CL (mL/min)', 'Log BW', 'Log CL'];
                                
                                // 设置固定的Body Weight值
                                const fixedBodyWeights = {
                                    0: 0.025,  // Mouse (15行)
                                    1: 0.3,    // Rat (16行)
                                    2: 10,     // Dog (17行)
                                    3: 5,      // Monkey (18行)
                                    4: 60,     // Human (19行)
                                    6: 0.02,   // C21
                                    7: 0.01    // C22
                                };

                                // 设置固定的CL值
                                const fixedCLValues = {
                                    0: 0.0548,  // Mouse (15行)
                                    1: 1.24,    // Rat (16行)
                                    2: 10.363,  // Dog (17行)
                                    3: 19.431,  // Monkey (18行)
                                    4: 0.02,    // C20
                                    5: 0.02,    // C21 (默认值)
                                    6: 0.01,    // C22 (默认值)
                                    7: 2,       // C23 = C21/C22 = 0.02/0.01 = 2
                                    8: 0.02,    // C24
                                    10: 2       // C26 = C24/C25 = 0.02/0.01 = 2
                                };
                                
                                const cleanData = [];
                                
                                // 添加基础数据（Mouse到Human）
                                const animals = ['Mouse', 'Rat', 'Dog', 'Monkey', 'Human'];
                                animals.forEach((animal, index) => {
                                    const obj = {
                                        'Item': '',
                                        'Animal': animal,
                                        'Body Weight (kg)': fixedBodyWeights[index],
                                        'CL (mL/min)': fixedCLValues[index],
                                        'Log BW': Math.log10(fixedBodyWeights[index]),
                                        'Log CL': fixedCLValues[index] ? Math.log10(fixedCLValues[index]) : null
                                    };
                                    cleanData.push(obj);
                                });

                                // 添加额外的计算行（C21-C23）
                                for (let i = 5; i <= 7; i++) {
                                    const obj = {
                                        'Item': '',
                                        'Animal': '',
                                        'Body Weight (kg)': null,
                                        'CL (mL/min)': fixedCLValues[i],
                                        'Log BW': null,
                                        'Log CL': null
                                    };
                                    cleanData.push(obj);
                                }

                                // 第二个表的数据（4行2列）
                                const table2Data = [
                                    { 'Column 1': 'a', 'Column 2': '2.42' },
                                    { 'Column 1': 'fu_rat', 'Column 2': '0.02' },
                                    { 'Column 1': 'fu_human', 'Column 2': '0.01' },
                                    { 'Column 1': 'Rfu', 'Column 2': '2.00' }
                                ];

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                                tablesHtml += '<h3>FCIM Data</h3>';
                                tablesHtml += createTableHtml(cleanData);
                        
                        // 第二个表格
                                tablesHtml += '<h3 style="margin-top: 20px;">Additional Data</h3>';
                                tablesHtml += createEditableTable2Html(table2Data);
                                
                                // 计算并显示实际值
                                const b1 = parseFloat(table2Data[0]['Column 2']); // a的值
                                const b4 = parseFloat(table2Data[3]['Column 2']); // Rfu的值
                                const clMin = 33.35 * Math.pow(b1/b4, 0.77);
                                const clHr = clMin * 0.06;
                                
                                tablesHtml += '<div style="margin-top: 10px; font-size: 14px; color: #666;">';
                                tablesHtml += `CL human (L/min) = ${clMin.toFixed(2)}<br>`;
                                tablesHtml += `CL human (L/hr) = ${clHr.toFixed(2)}`;
                        tablesHtml += '</div>';
                        
                                // 添加拟合按钮
                                tablesHtml += '<div style="margin-top: 20px; text-align: center;">';
                                tablesHtml += '<button class="csv-button" onclick="plotFCIMFitting()">拟合图</button>';
                                tablesHtml += '</div>';
                                
                                tablesHtml += '</div>';
                                
                                document.getElementById('tableContainer').innerHTML = tablesHtml;
                        
                        // 存储FCIM数据到全局变量
                                currentFCIMData = {
                                    mainTable: cleanData,
                                    secondTable: table2Data
                                };
                        
                                // 更新图表
                                updateChart(cleanData, filename);
                    };
                    break;

                case 'IVIVE for CL.csv':
                    config.header = false;
                    config.skipEmptyLines = false;
                    config.complete = function(results) {
                        console.log('IVIVE raw data:', results.data);
                        const rawData = results.data;
                        currentIVIVEData = rawData;
                        displayIVIVEData(rawData, filename);
                    };
                    break;

                case 'Wajim-CL.csv':
                    config.header = false;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Wajim raw data:', results.data);

                        // 创建两个独立的数据集
                        const mainData = [
                            // 设置固定值
                            { Parameter: 'CLrat', Value: 6.20 },
                            { Parameter: 'CLdog', Value: 2.15 },
                            { Parameter: 'MW', Value: 614 },
                            { Parameter: 'Ha', Value: 12 }
                        ];
                        
                        // 创建 CL human 数据表
                        const clHumanData = [
                            // 第一行：标题行
                            {
                                Col1: 'logCLhuman',
                                        Col2: 'CL human mL/min/kg',
                                        Col3: 'CL human mL/min',
                                        Col4: 'CL human'
                            },
                            // 第二行：可输入的值
                            {
                                        Col1: calculateLogCLHuman(mainData),
                                Col2: null,
                                Col3: null,
                                Col4: null
                            }
                        ];
                                
                                // 自动计算B2, C2, D2的值
                                const logCLHuman = parseFloat(clHumanData[1].Col1);
                                if (!isNaN(logCLHuman)) {
                                    const b2 = Math.pow(10, logCLHuman);  // B2 = 10^A2
                                    const c2 = b2 * 60;  // C2 = B2 * 60
                                    const d2 = c2 * 0.06;  // D2 = C2 * 0.06
                                    
                                    clHumanData[1].Col2 = b2;
                                    clHumanData[1].Col3 = c2;
                                    clHumanData[1].Col4 = d2;
                                }

                        // 创建两个表格的HTML
                        let tablesHtml = '<div style="margin-bottom: 20px;">';
                        
                        // 第一个表格
                        tablesHtml += '<h3>Main Parameters</h3>';
                        tablesHtml += createTableHtml(mainData);
                        
                        // 第二个表格
                        tablesHtml += '<h3 style="margin-top: 20px;">CL Human Values</h3>';
                        tablesHtml += createEditableTableHtml(clHumanData);
                        
                        tablesHtml += '</div>';
                        
                        document.getElementById('tableContainer').innerHTML = tablesHtml;

                                // 存储数据到全局变量
                                currentWajimData = {
                                    mainData: mainData,
                                    clHumanData: clHumanData
                                };

                        // 更新图表（使用主数据）
                        updateChart(mainData, filename);
                    };
                    break;

                default:
                    config.header = true;
                    config.skipEmptyLines = true;
                    config.complete = function(results) {
                        console.log('Raw data:', results.data);

                        // 清理数据并只保留有数据的列
                        const cleanData = results.data
                            .filter(row => Object.values(row).some(v => v !== null && v !== ''))
                            .map(row => {
                                // 只保留有数据的列
                                const cleanRow = {};
                                if (row['Compound']) cleanRow['Compound'] = row['Compound'];
                                if (row['BW(kg)']) cleanRow['BW(kg)'] = row['BW(kg)'];
                                if (row['fu']) cleanRow['fu'] = row['fu'];
                                if (row['CL(L/h)']) cleanRow['CL(L/h)'] = row['CL(L/h)'];
                                if (row['CL/fu']) cleanRow['CL/fu'] = row['CL/fu'];
                                if (row['Vss (L)']) cleanRow['Vss (L)'] = row['Vss (L)'];
                                if (row['Vss/fu']) cleanRow['Vss/fu'] = row['Vss/fu'];
                                return cleanRow;
                            })
                            .filter(row => Object.keys(row).length > 0); // 确保行中有数据

                        // 存储数据到全局变量
                        if (filename === 'CL and Vss in preclinical.csv') {
                            currentCLVssData = cleanData;
                        }
                        
                        displayData(cleanData, filename);
                    };
                    break;
            }

            // 添加调试信息
            console.log('正在加载文件:', filename);
            console.log('使用的配置:', config);

                    Papa.parse(csvData, config);
                });
        }

        function getColumnLabel(index) {
            // 将列索引转换为字母标识（A=0, B=1, etc.）
            let label = '';
            while (index >= 0) {
                label = String.fromCharCode(65 + (index % 26)) + label;
                index = Math.floor(index / 26) - 1;
            }
            return label;
        }

        // 添加专门用于显示IVIVE数据的函数
        function displayIVIVEData(rawData, filename) {
            if (!rawData || rawData.length === 0) return;
            
            let table = '<table class="data-table"><tbody>';
            
            // 遍历原始数据行，但跳过A24和A25行
            for (let i = 0; i < rawData.length; i++) {
                // 跳过input data和output data行
                if (i === 23 || i === 24) continue;
                
                const row = rawData[i];
                
                // 跳过完全空的行
                if (row.every(cell => !cell)) {
                    table += '<tr><td class="cell-container">';
                    table += `<div class="cell-position">A${i+2}</div>`;
                    table += '</td></tr>';
                    continue;
                }
                
                // 检查是否是需要特殊样式的行（A2, A3, A11, A12）
                const isSpecialRow = (i === 0 || i === 1 || i === 9 || i === 10);
                
                table += isSpecialRow ? 
                    '<tr style="background-color: #4CAF50; color: white;">' : 
                    '<tr>';
                
                // 处理每一行的单元格
                for (let j = 0; j < row.length; j++) {
                    // 如果是第一行（i=0）或第十行（i=9）且是D到G列（j=3到6），合并单元格显示Mxsomes
                    if ((i === 0 || i === 9) && j >= 3 && j <= 6) {
                        if (j === 3) {
                            // 只在D列显示合并的单元格
                            table += `<td class="cell-container" colspan="4" style="text-align: center;">
                                <div class="cell-position" style="color: ${isSpecialRow ? 'rgba(255,255,255,0.7)' : '#999'}">${getColumnLabel(j)}${i+2}</div>
                                <div class="cell-content">Mxsomes</div>
                            </td>`;
                        }
                        continue; // 跳过E、F、G列
                    }

                    // 如果是第一行（i=0）或第十行（i=9）且是H到K列（j=7到10），合并单元格显示Hep
                    if ((i === 0 || i === 9) && j >= 7 && j <= 10) {
                        if (j === 7) {
                            // 只在H列显示合并的单元格
                            table += `<td class="cell-container" colspan="4" style="text-align: center;">
                                <div class="cell-position" style="color: ${isSpecialRow ? 'rgba(255,255,255,0.7)' : '#999'}">${getColumnLabel(j)}${i+2}</div>
                                <div class="cell-content">Hep</div>
                            </td>`;
                        }
                        continue; // 跳过I、J、K列
                    }

                    let cellContent = row[j] || '';
                    const cellPosition = `${getColumnLabel(j)}${i+2}`;
                    
                    // 如果是A3或A12行，设置列标题
                    if ((i === 1 || i === 10) && j < iviveHeaders.length) {
                        cellContent = iviveHeaders[j];
                    }
                    
                    // 检查是否是可编辑列（B=1, D=3, E=4, H=7, I=8, L=11, U=20）
                    const editableColumns = [1, 3, 4, 7, 8, 11, 20];
                    if (editableColumns.includes(j) && i > 0 && i !== 8 && i !== 9 && i !== 1 && i !== 10) {
                        // 创建可编辑的输入框
                        table += `<td class="cell-container">
                                <div class="cell-position" style="color: ${isSpecialRow ? 'rgba(255,255,255,0.7)' : '#999'}">${cellPosition}</div>
                                <input type="number" 
                                class="cell-input"
                                value="${cellContent}" 
                                step="0.000001"
                                data-row="${i}"
                                data-col="${j}"
                                onchange="updateIVIVEValue(this.value, this.dataset.row, this.dataset.col)"
                                />
                            </td>`;
                    } else {
                        // 其他列保持原样显示
                        table += '<td class="cell-container">';
                        table += `<div class="cell-position" style="color: ${isSpecialRow ? 'rgba(255,255,255,0.7)' : '#999'}">${cellPosition}</div>`;
                        
                        // 格式化数字
                        if (!isNaN(parseFloat(cellContent)) && isFinite(cellContent)) {
                            const num = parseFloat(cellContent);
                            if (num % 1 !== 0) {
                                cellContent = num.toFixed(6);
                            }
                        }
                        
                        // 处理特殊值
                        if (cellContent === "#DIV/0!" || cellContent === "#REF!" || cellContent === "#VALUE!") {
                            cellContent = `<span class="error-value">${cellContent}</span>`;
                        }
                        
                        table += `<div class="cell-content">${cellContent}</div>`;
                    }
                    
                    table += '</td>';
                }
                
                table += '</tr>';
            }

            table += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = table;
        }

        function displayData(results) {
            if (!results || results.data.length === 0) {
                console.error('没有数据可显示');
                return;
            }
            
            // 在数据的开头插入一个空行
            let newData = [Array(results.data[0].length).fill("")];  // 创建一个空行
            newData = newData.concat(results.data);  // 将原始数据添加到空行后面
            
            // 创建表格HTML
            let tableHtml = '<table border="1">';
            for (let i = 0; i < newData.length; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < newData[i].length; j++) {
                    tableHtml += '<td>' + newData[i][j] + '</td>';
                }
                tableHtml += '</tr>';
            }
            tableHtml += '</table>';
            
            // 添加表格到页面
            document.getElementById('tableContainer').innerHTML = tableHtml;

            // 更新图表
            updateChart(results.data, 'CL and Vss in preclinical.csv');
        }

        function updateChart(data, filename) {
            if (currentChart) {
                currentChart.destroy();
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            const headers = Object.keys(data[0]);
            
            // 根据文件名选择合适的图表配置
            const chartConfig = getChartConfig(filename, data, headers);
            currentChart = new Chart(ctx, chartConfig);
        }

        function getChartConfig(filename, data, headers) {
            if (filename === 'Allometry-CL.csv') {
                // 找到包含有效数据的列
                const validHeaders = headers.filter(header => 
                    data.some(row => row[header] !== null && !isNaN(row[header]))
                );

                // 找到可能的x轴数据（通常是体重或其他度量）
                const xHeader = validHeaders.find(h => 
                    h.toLowerCase().includes('weight') || 
                    h.toLowerCase().includes('bw') ||
                    h.toLowerCase().includes('brain')
                ) || validHeaders[0];

                // 创建数据集
                const datasets = validHeaders
                    .filter(header => header !== xHeader)
                    .map(header => ({
                        label: header,
                        data: data
                            .filter(row => 
                                row[xHeader] !== null && 
                                row[header] !== null && 
                                !isNaN(row[xHeader]) && 
                                !isNaN(row[header])
                            )
                            .map(row => ({
                                x: row[xHeader],
                                y: row[header]
                            })),
                        backgroundColor: getRandomColor()
                    }))
                    .filter(dataset => dataset.data.length > 0);

                return {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Allometry Analysis',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: (${context.parsed.x}, ${context.parsed.y})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: xHeader
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Values'
                                }
                            }
                        }
                    }
                };
            }
            
            // 根据不同的文件选择不同的图表配置
            if (filename === 'CL and Vss in preclinical.csv') {
                return {
                    type: 'bar',
                    data: {
                        labels: data.map(row => row['Compound']),  // 使用 Compound 作为标签
                        datasets: [
                            {
                                label: 'CL(L/h)',
                                data: data.map(row => row['CL(L/h)']),
                                backgroundColor: 'rgba(75, 192, 192, 0.5)'
                            },
                            {
                                label: 'Vss (L)',
                                data: data.map(row => row['Vss (L)']),
                                backgroundColor: 'rgba(255, 99, 132, 0.5)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'CL and Vss in Preclinical',
                                font: { size: 16 }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { 
                                    display: true,
                                    text: 'Value'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                };
            }
            
            // 修改FCIM的图表配置
            if (filename === 'FCIM.csv') {
                return {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Log CL vs Log BW',
                            data: data
                                .filter(row => 
                                    row['Log BW'] !== null && 
                                    row['Log CL'] !== null && 
                                    !isNaN(row['Log BW']) && 
                                    !isNaN(row['Log CL'])
                                )
                                .map(row => ({
                                    x: row['Log BW'],
                                    y: row['Log CL']
                                })),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'FCIM Analysis - Log CL vs Log BW',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `(${context.parsed.x.toFixed(4)}, ${context.parsed.y.toFixed(4)})`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Log BW'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Log CL'
                                }
                            }
                        }
                    }
                };
            }
            
            if (filename === 'IVIVE for CL.csv') {
                // 创建一个多系列的散点图，比较不同物种的数据
                const datasets = [];
                
                // 按Species分组
                const speciesGroups = {};
                data.forEach(row => {
                    if (row['Species'] && row['CLint'] && row['fu, inc']) {
                        const species = row['Species'];
                        if (!speciesGroups[species]) {
                            speciesGroups[species] = [];
                        }
                        speciesGroups[species].push(row);
                    }
                });
                
                // 为每个物种创建一个数据集
                const colors = {
                    'h': 'rgba(75, 192, 192, 0.8)',   // 人 - 蓝绿色
                    'm': 'rgba(255, 99, 132, 0.8)',   // 鼠 - 红色
                    'r': 'rgba(255, 206, 86, 0.8)',   // 大鼠 - 黄色
                    'd': 'rgba(54, 162, 235, 0.8)',   // 狗 - 蓝色
                    'c': 'rgba(153, 102, 255, 0.8)'   // 猴 - 紫色
                };
                
                const speciesLabels = {
                    'h': 'Human',
                    'm': 'Mouse',
                    'r': 'Rat',
                    'd': 'Dog',
                    'c': 'Monkey'
                };
                
                // 如果没有按物种分组成功，创建单一数据集
                if (Object.keys(speciesGroups).length === 0) {
                return {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'CLint vs fu',
                            data: data
                                .filter(row => 
                                    row['CLint'] !== null && 
                                    row['fu, inc'] !== null &&
                                    !isNaN(row['CLint']) && 
                                    !isNaN(row['fu, inc'])
                                )
                                .map(row => ({
                                    x: row['fu, inc'],
                                    y: row['CLint']
                                })),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'IVIVE Analysis',
                                font: { size: 16 }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'fu, inc'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'CLint'
                                    }
                                }
                            }
                        }
                    };
                }
                
                // 为每个物种创建数据集
                Object.entries(speciesGroups).forEach(([species, rows]) => {
                    const speciesLabel = speciesLabels[species] || species;
                    
                    // 创建数据集
                    datasets.push({
                        label: speciesLabel,
                        data: rows.map(row => ({
                            x: row['fu, inc'],
                            y: row['CLint']
                        })),
                        backgroundColor: colors[species] || getRandomColor(),
                        borderColor: colors[species]?.replace('0.8', '1') || getRandomColor(),
                        pointRadius: 6,
                        pointHoverRadius: 8
                    });
                });
                
                return {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'IVIVE Analysis - CLint vs fu, inc by Species',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: CLint=${context.parsed.y.toFixed(2)}, fu=${context.parsed.x.toFixed(4)}`;
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'fu, inc'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'CLint'
                                }
                            }
                        }
                    }
                };
            }
            
            if (filename === 'Wajim-CL.csv') {
                // 只使用数值类型的数据进行图表显示
                const numericData = data.filter(row => 
                    row.Value !== null && 
                    typeof row.Value === 'number' && 
                    !isNaN(row.Value)
                );
                
                return {
                    type: 'bar',
                    data: {
                        labels: numericData.map(row => row.Parameter),
                        datasets: [{
                            label: 'Values',
                            data: numericData.map(row => row.Value),
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: numericData.length === 0 ? 'No numeric data available' : 'Wajim-CL Analysis',
                                font: { size: 16 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const row = numericData[context.dataIndex];
                                        return row ? `${row.Value.toFixed(4)}${row.Unit ? ' ' + row.Unit : ''}` : '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                };
            }
            
            // 默认配置（用于其他文件）
            return {
                type: 'scatter',
                data: {
                    datasets: headers.slice(1).map(header => ({
                        label: header,
                        data: data.map(row => ({
                            x: row[headers[0]],
                            y: row[header]
                        })).filter(point => 
                            point.x !== null && 
                            point.y !== null && 
                            !isNaN(point.x) && 
                            !isNaN(point.y)
                        ),
                        backgroundColor: getRandomColor()
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: filename,
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return `${label}: ${value.toFixed(4)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: headers[0]
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '值'
                            }
                        }
                    }
                }
            };
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // 添加更新CL值的函数
        function updateCLValue(rowIndex, newValue) {
            if (!currentFCIMData) return;

            // 更新数据
            currentFCIMData[rowIndex]['CL (mL/min)'] = parseFloat(newValue);
            
            // 计算新的Log CL值
            if (!isNaN(newValue) && newValue > 0) {
                currentFCIMData[rowIndex]['Log CL'] = Math.log10(parseFloat(newValue));
                
                // Update fixedCLValues for C21 and C22
                const actualRowNumber = rowIndex + 15;  // Convert to actual row number
                if (actualRowNumber === 21) {  // C21
                    fixedCLValues[5] = parseFloat(newValue);  // Update C21 value
                    // Recalculate C23 = C21/C22
                    if (fixedCLValues[6] !== undefined) {  // If C22 exists
                        fixedCLValues[7] = fixedCLValues[5] / fixedCLValues[6];
                    }
                } else if (actualRowNumber === 22) {  // C22
                    fixedCLValues[6] = parseFloat(newValue);  // Update C22 value
                    // Recalculate C23 = C21/C22
                    if (fixedCLValues[5] !== undefined) {  // If C21 exists
                        fixedCLValues[7] = fixedCLValues[5] / fixedCLValues[6];
                    }
                }
            } else {
                currentFCIMData[rowIndex]['Log CL'] = null;
            }

            // 更新显示
            displayData(currentFCIMData, 'FCIM.csv');
        }

        // 添加更新 CL and Vss 值的函数
        function updateCLVssValue(newValue, rowIndex, colIndex) {
            if (!currentCLVssData) return;

            // 更新输入值
            currentCLVssData[rowIndex][colIndex] = parseFloat(newValue);
            
                const row = currentCLVssData[rowIndex];
            
            // 计算CL/fu (第10列)
            if (colIndex === 5 || colIndex === 8) { // 如果更新了CL(L/h)或fu
                const clValue = parseFloat(row[5]); // CL(L/h)
                const fuValue = parseFloat(row[8]); // fu
                if (!isNaN(clValue) && !isNaN(fuValue) && fuValue !== 0) {
                    row[9] = clValue / fuValue;
                }
            }
            
            // 计算Vss/fu (第11列)
            if (colIndex === 7 || colIndex === 8) { // 如果更新了Vss或fu
                const vssValue = parseFloat(row[7]); // Vss
                const fuValue = parseFloat(row[8]); // fu
                if (!isNaN(vssValue) && !isNaN(fuValue) && fuValue !== 0) {
                    row[10] = vssValue / fuValue;
                }
            }
            
            // 重新显示数据
                displayData(currentCLVssData, 'CL and Vss in preclinical.csv');
        }

        // 添加创建表格的辅助函数
        function createTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            // 创建数据行，从37开始编号
            data.forEach((row, rowIndex) => {
                const actualRowNumber = rowIndex + 37;  // 行号从37开始
                table += `<tr><td class="row-header">${actualRowNumber}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${actualRowNumber}`;
                    let formattedValue = '';
                    
                    // 计算对数值
                    if (header !== 'Item' && currentAllometryData && currentAllometryData.mainData) {
                        const mainRow = currentAllometryData.mainData[rowIndex];
                        if (mainRow) {
                            switch(header) {
                                case 'Log BW':
                                    if (mainRow['Body Weight (kg)'] > 0) {
                                        formattedValue = Math.log10(mainRow['Body Weight (kg)']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'if 0.55＜b ≤0.71':
                                    if (mainRow['Cl(L/h)'] > 0) {
                                        formattedValue = Math.log10(mainRow['Cl(L/h)']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'if 0.71＜b ≤1':
                                    if (mainRow['CL*MLP'] > 0) {
                                        formattedValue = Math.log10(mainRow['CL*MLP']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'if 1＜b ≤1.3':
                                case 'log CL*BrW':
                                    if (mainRow['CL*BrW'] > 0) {
                                        formattedValue = Math.log10(mainRow['CL*BrW']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'log CL/Fu':
                                    if (mainRow['CL/Fu'] > 0) {
                                        formattedValue = Math.log10(mainRow['CL/Fu']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'log CL/Fu*MLP':
                                    if (mainRow['CL/Fu*MLP'] > 0) {
                                        formattedValue = Math.log10(mainRow['CL/Fu*MLP']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                case 'log CL/Fu*BrW':
                                    if (mainRow['CL/Fu*BrW'] > 0) {
                                        formattedValue = Math.log10(mainRow['CL/Fu*BrW']).toFixed(4);
                                        row[header] = parseFloat(formattedValue);
                                    }
                                    break;
                                default:
                                    formattedValue = value || '';
                            }
                        }
                    } else {
                        formattedValue = value || '';
                    }

                    table += `<td class="output-cell">
                        <div class="cell-position">${cellPosition}</div>
                        ${formattedValue}
                    </td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 修改创建可编辑表格的函数
        function createEditableTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = ['Col1', 'Col2', 'Col3', 'Col4'];
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th><div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            data.forEach((row, rowIndex) => {
                table += `<tr><td class="row-header">${rowIndex + 1}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${rowIndex + 1}`;
                    
                    if (rowIndex === 0) {  // 第一行是标题
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${value || ''}
                        </td>`;
                    } else if (colIndex === 0) {  // A2是可编辑的
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            <input type="number" 
                                value="${value || ''}" 
                                step="0.0001"
                                style="width: 100px;"
                                onchange="updateCLHumanValue(${colIndex}, this.value)"
                            />
                        </td>`;
                    } else {  // B2, C2, D2是计算结果
                        let displayValue = '';
                        if (value !== null && value !== undefined) {
                            displayValue = typeof value === 'number' ? value.toFixed(4) : value;
                        }
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${displayValue}
                        </td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 修改更新 CL human 值的函数
        function updateCLHumanValue(colIndex, newValue) {
            if (!currentWajimData) {
                // 如果currentWajimData不存在，初始化它
                currentWajimData = {
                    mainData: [
                        { Parameter: 'CLrat', Value: 6.20 },
                        { Parameter: 'CLdog', Value: 2.15 },
                        { Parameter: 'MW', Value: 614 },
                        { Parameter: 'Ha', Value: 12 }
                    ],
                    clHumanData: [
                        {
                            Col1: 'logCLhuman',
                            Col2: 'CL human mL/min/kg',
                            Col3: 'CL human mL/min',
                            Col4: 'CL human'
                        },
                        {
                            Col1: null,
                            Col2: null,
                            Col3: null,
                            Col4: null
                        }
                    ]
                };
            }

            const value = parseFloat(newValue);
            if (!isNaN(value)) {
                // 更新A2的值
                currentWajimData.clHumanData[1].Col1 = value;
                
                // 计算B2, C2, D2的值
                const logCLHuman = parseFloat(value);
                const b2 = Math.pow(10, logCLHuman);  // B2 = 10^A2
                const c2 = b2 * 60;  // C2 = B2 * 60
                const d2 = c2 * 0.06;  // D2 = C2 * 0.06
                
                // 更新表格中的值
                currentWajimData.clHumanData[1].Col2 = b2;
                currentWajimData.clHumanData[1].Col3 = c2;
                currentWajimData.clHumanData[1].Col4 = d2;
                
                // 更新显示
                document.getElementById('tableContainer').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>Main Parameters</h3>
                        ${createTableHtml(currentWajimData.mainData)}
                        <h3 style="margin-top: 20px;">CL Human Values</h3>
                        ${createEditableTableHtml(currentWajimData.clHumanData)}
                    </div>
                `;
            }
        }

        // 添加新的函数来创建特殊的Allometry表格
        function createAllometryTableHtml(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            
            // 创建表头
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            // 创建数据行，从23开始编号
            data.forEach((row, rowIndex) => {
                const actualRowNumber = rowIndex + 23;  // 行号从23开始
                table += `<tr><td class="row-header">${actualRowNumber}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${actualRowNumber}`;  // 使用新的行号
                    
                    // Body Weight (kg)列使用固定值
                    if (header === 'Body Weight (kg)') {
                        let fixedValue;
                        switch(actualRowNumber) {
                            case 23: fixedValue = 0.025; break;  // Mouse
                            case 24: fixedValue = 0.3; break;    // Rat
                            case 25: fixedValue = 10; break;     // Dog
                            case 26: fixedValue = 5; break;      // Monkey
                            default: fixedValue = 60; break;     // Human (27-32)
                        }
                        table += `<td class="constant-cell">
                            <div class="cell-position">${cellPosition}</div>
                            ${fixedValue.toFixed(4)}
                        </td>`;
                        row[header] = fixedValue;  // 更新数据
                        
                        // 同时计算Brain Weight
                        if (header === 'Body Weight (kg)') {
                            switch(row['Animal']) {
                                case 'Mouse':
                                    row['Brain Weight (kg)'] = fixedValue * 1.65/100;
                                    break;
                                case 'Rat':
                                    row['Brain Weight (kg)'] = fixedValue * 0.57/100;
                                    break;
                                case 'Dog':
                                    row['Brain Weight (kg)'] = fixedValue * 0.78/100;
                                    break;
                                case 'Monkey':
                                    row['Brain Weight (kg)'] = fixedValue * 1.56/100;
                                    break;
                                case 'Human':
                                    row['Brain Weight (kg)'] = fixedValue * 2/100;
                                    break;
                            }
                        }
                    }
                    // Brain Weight (kg)列显示计算结果
                    else if (header === 'Brain Weight (kg)') {
                        table += `<td class="output-cell">
                            <div class="cell-position">${cellPosition}</div>
                            ${typeof value === 'number' ? value.toFixed(4) : (value || '')}
                        </td>`;
                    }
                    // Animal列不可编辑
                    else if (header === 'Animal') {
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${value || ''}
                        </td>`;
                    }
                    // 用户输入值列
                    else if (header === 'Fu') {
                        table += `<td class="input-cell">
                            <div class="cell-position">${cellPosition}</div>
                            <input type="number" 
                                value="${value || 1}" 
                                step="0.0001"
                                style="width: 100px;"
                                onchange="updateAllometryValue('${header}', ${rowIndex}, this.value)"
                            />
                        </td>`;
                    }
                    // 输出值列
                    else {
                        table += `<td class="output-cell">
                            <div class="cell-position">${cellPosition}</div>
                            ${typeof value === 'number' ? value.toFixed(4) : (value || '')}
                        </td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 更新updateAllometryValue函数以处理计算逻辑
        function updateAllometryValue(header, rowIndex, newValue) {
            if (!currentAllometryData || !currentAllometryData.mainData) return;

            const row = currentAllometryData.mainData[rowIndex];
            const value = parseFloat(newValue);
            
            if (!isNaN(value)) {
                row[header] = value;
                
                // 更新所有行的计算
                currentAllometryData.mainData.forEach((currentRow, currentRowIndex) => {
                    // 计算 Brain Weight (I列)
                    if (header === 'Body Weight (kg)') {
                        const bodyWeight = currentRow['Body Weight (kg)'];
                        if (bodyWeight) {
                            switch(currentRow['Animal']) {
                                case 'Mouse':
                                    currentRow['Brain Weight (kg)'] = bodyWeight * 1.65/100;
                                    break;
                                case 'Rat':
                                    currentRow['Brain Weight (kg)'] = bodyWeight * 0.57/100;
                                    break;
                                case 'Dog':
                                    currentRow['Brain Weight (kg)'] = bodyWeight * 0.78/100;
                                    break;
                                case 'Monkey':
                                    currentRow['Brain Weight (kg)'] = bodyWeight * 1.56/100;
                                    break;
                                case 'Human':
                                    currentRow['Brain Weight (kg)'] = bodyWeight * 2/100;
                                    break;
                            }
                        }
                    }

                    // 计算 MLP (J列)
                    const bodyWeight = currentRow['Body Weight (kg)'];
                    const brainWeight = currentRow['Brain Weight (kg)'];
                    if (bodyWeight && brainWeight) {
                        currentRow['MLP (years)'] = 185.4 * Math.pow(brainWeight, 0.636) * Math.pow(bodyWeight, -0.225);
                    }

                    // 获取基础值
                    const mlp = currentRow['MLP (years)'];
                    const cl = currentRow['Cl(L/h)'];
                    const fu = currentRow['Fu'];

                    // 计算 CL*MLP (N列)
                    if (cl && mlp) {
                        currentRow['CL*MLP'] = cl * mlp;
                    }

                    // 计算 CL*BrW (O列)
                    if (cl && brainWeight) {
                        currentRow['CL*BrW'] = cl * brainWeight;
                    }

                    // 计算 CL/Fu (P列)
                    if (cl && fu) {
                        currentRow['CL/Fu'] = cl / fu;
                    }

                    // 计算 CL/Fu*MLP (Q列)
                    if (currentRow['CL/Fu'] && mlp) {
                        currentRow['CL/Fu*MLP'] = currentRow['CL/Fu'] * mlp;
                    }

                    // 计算 CL/Fu*BrW (R列)
                    if (currentRow['CL/Fu'] && brainWeight) {
                        currentRow['CL/Fu*BrW'] = currentRow['CL/Fu'] * brainWeight;
                    }
                });

                // 特殊计算（Human rows）
                if (currentAllometryData.logData && currentAllometryData.logData[4]) {
                    const logData = currentAllometryData.logData[4];  // Human的log数据
                    const mainData = currentAllometryData.mainData;

                    // K27 (Human第一行): 10^I41
                    if (logData['log CL'] !== null) {
                        mainData[4]['Cl(L/h)'] = Math.pow(10, logData['log CL']);
                    }

                    // K28: N28/J28
                    if (mainData[5] && mainData[5]['CL*MLP'] && mainData[5]['MLP (years)']) {
                        mainData[5]['Cl(L/h)'] = mainData[5]['CL*MLP'] / mainData[5]['MLP (years)'];
                    }

                    // K29: O29/I29
                    if (mainData[6] && mainData[6]['CL*BrW'] && mainData[6]['Brain Weight (kg)']) {
                        mainData[6]['Cl(L/h)'] = mainData[6]['CL*BrW'] / mainData[6]['Brain Weight (kg)'];
                    }

                    // K30: P30*M30
                    if (mainData[7] && mainData[7]['CL/Fu'] && mainData[7]['Fu']) {
                        mainData[7]['Cl(L/h)'] = mainData[7]['CL/Fu'] * mainData[7]['Fu'];
                    }

                    // K31: P31/M31
                    if (mainData[8] && mainData[8]['CL/Fu'] && mainData[8]['Fu']) {
                        mainData[8]['Cl(L/h)'] = mainData[8]['CL/Fu'] / mainData[8]['Fu'];
                    }

                    // K32: P32*M30
                    if (mainData[9] && mainData[9]['CL/Fu'] && mainData[7] && mainData[7]['Fu']) {
                        mainData[9]['Cl(L/h)'] = mainData[9]['CL/Fu'] * mainData[7]['Fu'];
                    }
                }

                // 更新对数表的值
                currentAllometryData.mainData.forEach((mainRow, index) => {
                    if (index < currentAllometryData.logData.length) {
                        const logRow = currentAllometryData.logData[index];
                        
                        // 更新Log BW
                        if (mainRow['Body Weight (kg)'] > 0) {
                            logRow['Log BW'] = Math.log10(mainRow['Body Weight (kg)']);
                        }
                        
                        // 更新if 0.55＜b ≤0.71
                        if (mainRow['Cl(L/h)'] > 0) {
                            logRow['if 0.55＜b ≤0.71'] = Math.log10(mainRow['Cl(L/h)']);
                        }
                        
                        // 更新if 0.71＜b ≤1
                        if (mainRow['CL*MLP'] > 0) {
                            logRow['if 0.71＜b ≤1'] = Math.log10(mainRow['CL*MLP']);
                        }
                        
                        // 更新if 1＜b ≤1.3
                        if (mainRow['CL*BrW'] > 0) {
                            logRow['if 1＜b ≤1.3'] = Math.log10(mainRow['CL*BrW']);
                        }
                        
                        // 更新log CL*BrW
                        if (mainRow['CL*BrW'] > 0) {
                            logRow['log CL*BrW'] = Math.log10(mainRow['CL*BrW']);
                        }
                        
                        // 更新log CL/Fu
                        if (mainRow['CL/Fu'] > 0) {
                            logRow['log CL/Fu'] = Math.log10(mainRow['CL/Fu']);
                        }
                        
                        // 更新log CL/Fu*MLP
                        if (mainRow['CL/Fu*MLP'] > 0) {
                            logRow['log CL/Fu*MLP'] = Math.log10(mainRow['CL/Fu*MLP']);
                        }
                        
                        // 更新log CL/Fu*BrW
                        if (mainRow['CL/Fu*BrW'] > 0) {
                            logRow['log CL/Fu*BrW'] = Math.log10(mainRow['CL/Fu*BrW']);
                        }
                    }
                });

                // 更新显示
                document.getElementById('tableContainer').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3>Basic Parameters</h3>
                        ${createAllometryTableHtml(currentAllometryData.mainData)}
                        <h3 style="margin-top: 20px;">Logarithmic Values</h3>
                        ${createTableHtml(currentAllometryData.logData)}
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="csv-button" onclick="plotFitting1()">拟合图1</button>
                            <button class="csv-button" onclick="plotFitting2()">拟合图2</button>
                            <button class="csv-button" onclick="plotFitting3()">拟合图3</button>
                            <button class="csv-button" onclick="plotFitting4()">拟合图4</button>
                        </div>
                    </div>
                `;
                updateChart(currentAllometryData.mainData, 'Allometry-CL.csv');
            }
        }

        // Add new FCIM fitting function
        function plotFCIMFitting() {
            if (!currentFCIMData) return;

            const xValues = [];
            const yValues = [];

            // Get data points from E15:E18 and F15:F18 (first 4 rows)
            for (let i = 0; i < 4; i++) {
                const xValue = currentFCIMData.mainTable[i]['Log BW'];
                const yValue = currentFCIMData.mainTable[i]['Log CL'];
                if (xValue !== null && yValue !== null && !isNaN(xValue) && !isNaN(yValue)) {
                    xValues.push(xValue);
                    yValues.push(yValue);
                }
            }

            // Calculate linear regression
            const n = xValues.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (let i = 0; i < n; i++) {
                sumX += xValues[i];
                sumY += yValues[i];
                sumXY += xValues[i] * yValues[i];
                sumX2 += xValues[i] * xValues[i];
                sumY2 += yValues[i] * yValues[i];
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // Calculate R-squared
            const meanY = sumY / n;
            let totalSS = 0;
            let residualSS = 0;
            for (let i = 0; i < n; i++) {
                const predictedY = slope * xValues[i] + intercept;
                totalSS += Math.pow(yValues[i] - meanY, 2);
                residualSS += Math.pow(yValues[i] - predictedY, 2);
            }
            const rSquared = 1 - (residualSS / totalSS);
            const r = Math.sqrt(rSquared);

            // Create fitting line data points
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const fitX = [minX, maxX];
            const fitY = fitX.map(x => slope * x + intercept);

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            // Create new chart
            const ctx = document.getElementById('myChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '数据点',
                            data: xValues.map((x, i) => ({x: x, y: yValues[i]})),
                            backgroundColor: 'rgb(0, 0, 255)',
                            pointStyle: 'circle',
                            pointRadius: 6,
                            showLine: false
                        },
                        {
                            label: '拟合曲线',
                            data: fitX.map((x, i) => ({x: x, y: fitY[i]})),
                            backgroundColor: 'rgb(255, 0, 0)',
                            borderColor: 'rgb(255, 0, 0)',
                            pointStyle: 'line',
                            pointRadius: 0,
                            showLine: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'FCIM 拟合曲线',
                            font: { size: 16 },
                            padding: { top: 10, bottom: 30 }
                        },
                        subtitle: {
                            display: true,
                            text: `y = ${slope.toFixed(3)}x + ${intercept.toFixed(3)}    R = ${r.toFixed(3)}    R² = ${rSquared.toFixed(3)}`,
                            font: { size: 14 },
                            padding: { bottom: 10 }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Log BW'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Log CL'
                            }
                        }
                    }
                }
            });

            // Scroll to chart
            document.getElementById('chartContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // 添加通用的绘制拟合图函数
        function plotFittingGeneral(xColumn, yColumn, chartTitle) {
            if (!currentAllometryData || !currentAllometryData.logData) {
                console.error('No data available for plotting');
                return;
            }

            // 获取数据点
            const data = currentAllometryData.logData;
            const xValues = [];
            const yValues = [];

            // 获取I37:I40和指定Y列的数据
            for (let i = 0; i < 4; i++) {  // 4行数据
                const xValue = data[i][xColumn];  // I列 (Log BW)
                const yValue = data[i][yColumn];  // 指定的Y列
                if (xValue !== null && yValue !== null) {
                    xValues.push(xValue);
                    yValues.push(yValue);
                }
            }

            // 计算线性回归
            const n = xValues.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (let i = 0; i < n; i++) {
                sumX += xValues[i];
                sumY += yValues[i];
                sumXY += xValues[i] * yValues[i];
                sumX2 += xValues[i] * xValues[i];
                sumY2 += yValues[i] * yValues[i];
            }
            
            // 计算斜率和截距
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // 计算 R-squared
            const meanY = sumY / n;
            let totalSS = 0;
            let residualSS = 0;
            for (let i = 0; i < n; i++) {
                const predictedY = slope * xValues[i] + intercept;
                totalSS += Math.pow(yValues[i] - meanY, 2);
                residualSS += Math.pow(yValues[i] - predictedY, 2);
            }
            const rSquared = 1 - (residualSS / totalSS);
            const r = Math.sqrt(rSquared);

            // Create fitting line data points
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const fitX = [minX, maxX];
            const fitY = fitX.map(x => slope * x + intercept);

            // 销毁现有图表
            if (currentChart) {
                currentChart.destroy();
            }

            // 创建新图表
            const ctx = document.getElementById('myChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '数据点',
                            data: xValues.map((x, i) => ({x: x, y: yValues[i]})),
                            backgroundColor: 'rgb(0, 0, 255)',
                            pointStyle: 'circle',
                            pointRadius: 6,
                            showLine: false
                        },
                        {
                            label: '拟合曲线',
                            data: fitX.map((x, i) => ({x: x, y: fitY[i]})),
                            backgroundColor: 'rgb(255, 0, 0)',
                            borderColor: 'rgb(255, 0, 0)',
                            pointStyle: 'line',
                            pointRadius: 0,
                            showLine: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: { size: 16 },
                            padding: { top: 10, bottom: 30 }
                        },
                        subtitle: {
                            display: true,
                            text: `y = ${slope.toFixed(3)}x + ${intercept.toFixed(3)}    R = ${r.toFixed(3)}    R² = ${rSquared.toFixed(3)}`,
                            font: { size: 14 },
                            padding: { bottom: 10 }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Log BW'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yColumn
                            }
                        }
                    }
                }
            });

            // 滚动到图表位置
            document.getElementById('chartContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // 修改plotFitting1函数使用通用函数
        function plotFitting1() {
            plotFittingGeneral('Log BW', 'if 0.55＜b ≤0.71', '一次拟合曲线1');
        }

        // 添加新的拟合图函数
        function plotFitting2() {
            plotFittingGeneral('Log BW', 'if 0.71＜b ≤1', '一次拟合曲线2');
        }

        function plotFitting3() {
            plotFittingGeneral('Log BW', 'if 1＜b ≤1.3', '一次拟合曲线3');
        }

        function plotFitting4() {
            plotFittingGeneral('Log BW', 'log CL*BrW', '一次拟合曲线4');
        }

        // 添加新的函数来创建可编辑的第二个表格
        function createEditableTable2Html(data) {
            if (!data || data.length === 0) return '<p>No data available</p>';

            let table = '<table><thead><tr><th></th>';
            const headers = Object.keys(data[0]);
            headers.forEach((header, colIndex) => {
                const colLabel = getColumnLabel(colIndex);
                table += `<th>${header}<div class="cell-position">${colLabel}</div></th>`;
            });
            table += '</tr></thead><tbody>';

            data.forEach((row, rowIndex) => {
                const actualRowNumber = rowIndex + 1;
                table += `<tr><td class="row-header">${actualRowNumber}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header];
                    const cellPosition = `${getColumnLabel(colIndex)}${actualRowNumber}`;
                    
                    if (header === 'Column 2') {
                        // Column 2 是可编辑的
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            <input type="number" 
                                value="${value}" 
                                step="0.01"
                                style="width: 100px;"
                                onchange="updateTable2Value(${rowIndex}, this.value)"
                            />
                        </td>`;
                    } else {
                        // Column 1 显示固定值
                        table += `<td>
                            <div class="cell-position">${cellPosition}</div>
                            ${value}
                        </td>`;
                    }
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }

        // 添加更新第二个表格值的函数
        function updateTable2Value(rowIndex, newValue) {
            if (!currentFCIMData || !currentFCIMData.secondTable) return;
            
            currentFCIMData.secondTable[rowIndex]['Column 2'] = newValue;
            
            // Calculate B4 (Rfu) as B2/B3 whenever B2 or B3 changes
            if (rowIndex === 1 || rowIndex === 2) {  // If B2 (fu_rat) or B3 (fu_human) changes
                const fu_rat = parseFloat(currentFCIMData.secondTable[1]['Column 2']);
                const fu_human = parseFloat(currentFCIMData.secondTable[2]['Column 2']);
                if (!isNaN(fu_rat) && !isNaN(fu_human) && fu_human !== 0) {
                    currentFCIMData.secondTable[3]['Column 2'] = (fu_rat / fu_human).toFixed(2);
                }
            }
            
            // 更新显示
            document.getElementById('tableContainer').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>FCIM Data</h3>
                    ${createTableHtml(currentFCIMData.mainTable)}
                    <h3 style="margin-top: 20px;">Additional Data</h3>
                    ${createEditableTable2Html(currentFCIMData.secondTable)}
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="csv-button" onclick="plotFCIMFitting()">拟合图</button>
                    </div>
                </div>
            `;
        }

        // 添加计算 logCLhuman 的函数
        function calculateLogCLHuman(mainData) {
            // 获取所需的值
            const clrat = mainData.find(row => row.Parameter === 'CLrat')?.Value || 0;
            const cldog = mainData.find(row => row.Parameter === 'CLdog')?.Value || 0;
            const mw = mainData.find(row => row.Parameter === 'MW')?.Value || 0;
            const ha = mainData.find(row => row.Parameter === 'Ha')?.Value || 0;

            // 计算 logCLhuman
            const result = 0.433 * Math.log10(clrat) + 
                          1 * Math.log10(cldog) - 
                          0.00627 * mw + 
                          0.189 * ha - 
                          0.00111 * Math.log10(cldog) * mw + 
                          0.0000144 * mw * mw - 
                          0.0004 * mw * ha - 
                          0.707;

            return result.toFixed(4);
        }

        // 添加更新IVIVE值的函数
        function updateIVIVEValue(newValue, rowIndex, colIndex) {
            if (!currentIVIVEData) return;
            
            // 更新输入值
            currentIVIVEData[rowIndex][colIndex] = parseFloat(newValue);
            
            // 获取当前行的所有需要用到的值
            const row = currentIVIVEData[rowIndex];
            const bValue = parseFloat(row[1]);  // B列 (clogP/logD)
            const eValue = parseFloat(row[4]);  // E列 (CLint)
            const iValue = parseFloat(row[8]);  // I列 (CLint Hep)
            const lValue = parseFloat(row[11]); // L列 (MPPGL)
            const mValue = parseFloat(row[12]); // M列 (HPGL)
            const nValue = parseFloat(row[13]); // N列
            const oValue = parseFloat(row[14]); // O列 (Qh)
            const pValue = parseFloat(row[15]); // P列 (Liver)
            const uValue = parseFloat(row[20]); // U列 (CL,obs)

            // 判断是否是ISM024-155部分（使用0.5的部分）
            const useHalfCoefficient = rowIndex >= 17;
            const coefficient = useHalfCoefficient ? 0.5 : 1;

            // F列计算 (fu, inc)
            if (!isNaN(bValue)) {
                row[5] = 1 / (1 + coefficient * Math.pow(10, (0.56 * bValue - 1.41)));
            }

            // G列计算 (CLint,u)
            if (!isNaN(eValue) && !isNaN(row[5])) {
                row[6] = eValue / row[5];
            }

            // J列计算 (fu, inc Hep)
            if (!isNaN(bValue)) {
                row[9] = 1 / (1 + Math.pow(10, (0.56 * bValue - 1.41)));
            }

            // K列计算 (CLint,u Hep)
            if (!isNaN(iValue) && !isNaN(row[9])) {
                row[10] = iValue / row[9];
            }

            // Q列计算 (CLh pred. Clint)
            if (!isNaN(eValue) && !isNaN(mValue) && !isNaN(pValue) && !isNaN(lValue) && !isNaN(oValue)) {
                const numerator = eValue * mValue * pValue * lValue * 0.001 * oValue;
                const denominator = (eValue * mValue * pValue * lValue * 0.001) + oValue;
                row[16] = numerator / denominator;
            }

            // R列计算 (CLh pred. Clint, u)
            if (!isNaN(row[6]) && !isNaN(mValue) && !isNaN(pValue) && !isNaN(lValue) && !isNaN(oValue)) {
                const numerator = 0.001 * row[6] * mValue * pValue * lValue * oValue;
                const denominator = (0.001 * row[6] * mValue * pValue * lValue) + oValue;
                row[17] = numerator / denominator;
            }

            // S列计算 (CLh pred. Clint Hep)
            if (!isNaN(iValue) && !isNaN(nValue) && !isNaN(pValue) && !isNaN(lValue) && !isNaN(oValue)) {
                const numerator = iValue * nValue * pValue * lValue * oValue * 0.001;
                const denominator = (0.001 * iValue * lValue * nValue * pValue) + oValue;
                row[18] = numerator / denominator;
            }

            // T列计算 (CLh pred. Clint, u Hep)
            if (!isNaN(row[10]) && !isNaN(nValue) && !isNaN(lValue) && !isNaN(oValue) && !isNaN(pValue)) {
                const numerator = row[10] * 0.001 * nValue * lValue * oValue * pValue;
                const denominator = (0.001 * row[10] * lValue * nValue * pValue) + oValue;
                row[19] = numerator / denominator;
            }

            // IVIVC计算 (X-AA列)
            if (!isNaN(uValue)) {
                // X列 (_M CL pred.)
                if (!isNaN(row[16])) row[23] = uValue / row[16];
                // Y列 (_M Clpred. u)
                if (!isNaN(row[17])) row[24] = uValue / row[17];
                // Z列 (_H CL pred.)
                if (!isNaN(row[18])) row[25] = uValue / row[18];
                // AA列 (_H Clpred. u)
                if (!isNaN(row[19])) row[26] = uValue / row[19];
            }

            // 重新显示数据
            displayIVIVEData(currentIVIVEData, 'IVIVE for CL.csv');
        }

        // 在displayIVIVEData函数中添加或修改样式
        if (!document.getElementById('ivive-styles')) {
            const style = document.createElement('style');
            style.id = 'ivive-styles';
            style.innerHTML = `
                .data-table {
                    border-collapse: collapse;
                    width: 100%;
                    font-size: 12px;
                }
                .data-table td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    min-width: 100px;  /* 设置最小列宽 */
                    position: relative;
                }
                .data-table .cell-input {
                    width: 90%;  /* 输入框宽度 */
                    padding: 4px;
                    border: 1px solid #ddd;
                }
                .cell-position {
                    position: absolute;
                    top: 2px;
                    left: 2px;
                    font-size: 10px;
                    color: #999;
                }
                .cell-content {
                    margin-top: 12px;
                }
            `;
            document.head.appendChild(style);
        }

        function loadPreclinicalData() {
            Papa.parse('CL and Vss in preclinical.csv', {
                download: true,
                header: false,
                skipEmptyLines: false,
                complete: function(results) {
                    // 在数据开头插入空行
                    let emptyRow = Array(results.data[0].length).fill("");
                    results.data.unshift(emptyRow);
                    
                    preclinicalData = results.data;
                    
                    // 计算公式部分保持不变
                    for (let i = 2; i < preclinicalData.length; i++) {
                        // ... 现有的计算逻辑保持不变 ...
                    }
                    
                    // 创建表格HTML，美化第一行样式
                    let tableHtml = '<table border="1" class="data-table">';
                    for (let i = 0; i < preclinicalData.length; i++) {
                        if (i === 1) {
                            // 第一行（标题行）使用特殊样式
                            tableHtml += '<tr class="header-row">';
                            for (let j = 0; j < preclinicalData[i].length; j++) {
                                const cellValue = preclinicalData[i][j] || '';
                                tableHtml += `<td class="header-cell">${cellValue}</td>`;
                            }
                            tableHtml += '</tr>';
                        } else {
                            // 其他行保持原有逻辑
                            tableHtml += '<tr>';
                            for (let j = 0; j < preclinicalData[i].length; j++) {
                                const cellValue = preclinicalData[i][j] || '';
                                if ([1, 2, 3, 4, 5, 6, 7, 8, 9, 10].includes(j)) {
                                    if ([4, 5, 7, 9, 10].includes(j) && i >= 2) {
                                        const formattedValue = parseFloat(cellValue).toFixed(4);
                                        tableHtml += `<td class="readonly calculated">${formattedValue}</td>`;
                                    } else {
                                        tableHtml += `<td class="readonly">${cellValue}</td>`;
                                    }
                                } else {
                                    tableHtml += `<td class="editable" contenteditable="true">${cellValue}</td>`;
                                }
                            }
                            tableHtml += '</tr>';
                        }
                    }
                    tableHtml += '</table>';
                    
                    document.getElementById('preclinicalTable').innerHTML = tableHtml;
                    
                    // 更新CSS样式，添加标题行的样式
                    const style = document.createElement('style');
                    style.textContent = `
                        .data-table {
                            border-collapse: collapse;
                            width: 100%;
                            font-family: Arial, sans-serif;
                        }
                        
                        .header-row {
                            background-color: #f8f9fa;
                        }
                        
                        .header-cell {
                            padding: 12px;
                            text-align: center;
                            font-weight: bold;
                            color: #333;
                            border: 1px solid #dee2e6;
                            background-color: #f8f9fa;
                        }
                        
                        .readonly {
                            background-color: #f0f0f0;
                            cursor: not-allowed;
                            padding: 8px;
                        }
                        
                        .calculated {
                            background-color: #e8f4f8;
                        }
                        
                        .editable {
                            background-color: white;
                            cursor: text;
                            padding: 8px;
                        }
                        
                        .data-table td {
                            border: 1px solid #dee2e6;
                        }
                        
                        .data-table tr:hover {
                            background-color: #f5f5f5;
                        }
                    `;
                    document.head.appendChild(style);
                }
            });
        }

        // 添加数据更改时的重新计算功能
        function updateCalculations() {
            // 从第三行开始重新计算所有公式
            for (let i = 2; i < preclinicalData.length; i++) {
                // 重新计算所有公式
                preclinicalData[i][4] = parseFloat(preclinicalData[i][3]) * parseFloat(preclinicalData[i][2]); // E列
                preclinicalData[i][5] = parseFloat(preclinicalData[i][4]) * 0.06; // F列
                preclinicalData[i][7] = parseFloat(preclinicalData[i][6]) * parseFloat(preclinicalData[i][2]); // H列
                preclinicalData[i][9] = parseFloat(preclinicalData[i][5]) / parseFloat(preclinicalData[i][8]); // J列
                preclinicalData[i][10] = parseFloat(preclinicalData[i][6]) / parseFloat(preclinicalData[i][8]); // K列
            }
            // 更新表格显示
            loadPreclinicalData();
        }

        // 确保在页面加载时调用此函数
        window.onload = function() {
            loadPreclinicalData();
            // ... existing code ...
        };
    </script>
</body>
</html> 